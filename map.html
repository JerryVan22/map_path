<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>åœ°å›¾å¯¼èˆª</title>
  <script charset="utf-8" src="https://map.qq.com/api/gljs?v=1.exp&key=YO4BZ-32Q6X-TBE4P-7VBGQ-JZC32-ZQFWW"></script>
  <link rel="stylesheet" type="text/css" href="./map.css">
  <script src="./qwebchannel.js"></script>
  <script src="./fetch_data.js"></script>
</head>



<body>

  <div id="container"></div>
  <input type="button" id="btn-2d" onclick="change2D()" value="åˆ‡æ¢2D">
  <input type="button" id="btn-3d" onclick="change3D()" value="åˆ‡æ¢3D">
  <input type="button" id="btn-go" onclick="change3D()" value="å¯¼èˆª">
  <input type="button" id="btn-random" onclick="random_select()" value="éšæœºç”Ÿæˆ">
  <input type="button" id="btn-show_all" value="æ˜¾ç¤ºæ‰€æœ‰è¾¹">


  <select id="weather" title="å¤©æ°”">
    <option value="sunny">â˜€ï¸æ™´å¤©</option>
    <option value="cloudy">â›…å¤šäº‘</option>
    <option value="rain">ğŸŒ§ä¸‹é›¨</option>
    <option value="snow">â„ï¸ä¸‹é›ª</option>
  </select>

  <select id="trip_mode" title="å‡ºç°">
    <option value="walk">ğŸš¶â€â™‚ï¸æ­¥è¡Œ</option>
    <option value="cycle">ğŸš²éª‘è¡Œ</option>
    <option value="drive">ğŸš—é©¾è½¦</option>
  </select>

  <input type="time" id="cur_time" min="00:00" max="23:59" required>




  <select class="ct-select" id="place_of_departure">
  </select>

  <select class="ct-select2" id="destination">
  </select>




  <script type="text/javascript">

    var timeControl = document.querySelector('input[type="time"]');
    timeControl.value = '00:00';

    let sw = new TMap.LatLng(31.752313, 117.177401);
    let ne = new TMap.LatLng(31.780088, 117.195023);
    let boundary = new TMap.LatLngBounds(sw, ne);
    var center = new TMap.LatLng(31.76693, 117.18487);
    //åˆå§‹åŒ–åœ°å›¾
    var map = new TMap.Map("container", {
      zoom: 17,//è®¾ç½®åœ°å›¾ç¼©æ”¾çº§åˆ«
      center: center//è®¾ç½®åœ°å›¾ä¸­å¿ƒç‚¹åæ ‡
    });
    map.setMinZoom(16)
    map.setBoundary(boundary);



    function change2D() {
      map.setViewMode('2D');
    }

    function change3D() {
      map.setViewMode('3D');
      map.setPitch(70);
    }

    function random_select() {
      let dep = document.getElementById("place_of_departure");
      let dep_index = Math.floor(Math.random() * dep.options.length);
      dep.selectedIndex = dep_index;

      let des = document.getElementById("destination");
      let des_index = Math.floor(Math.random() * des.options.length);
      des.selectedIndex = des_index;



    }

    var marker = new TMap.MultiMarker({
      map: map,
    });


    printJSON(marker);
    var infoWindow = new TMap.InfoWindow({
      map: map,
      position: new TMap.LatLng(31.768709, 117.189064),
      offset: { x: 0, y: -32 } //è®¾ç½®ä¿¡æ¯çª—ç›¸å¯¹positionåç§»åƒç´ ï¼Œä¸ºäº†ä½¿å…¶æ˜¾ç¤ºåœ¨Markerçš„ä¸Šæ–¹
    });
    infoWindow.close();//åˆå§‹å…³é—­ä¿¡æ¯çª—å…³é—­
    //ç›‘å¬æ ‡æ³¨ç‚¹å‡»äº‹ä»¶
    marker.on("click", function (evt) {

      //è®¾ç½®infoWindow
      infoWindow.open(); //æ‰“å¼€ä¿¡æ¯çª—
      alert('hello world')
      infoWindow.setPoelfition(evt.geometry.position);//è®¾ç½®ä¿¡æ¯çª—ä½ç½®
      infoWindow.setContent(evt.geometry.position.toString());//è®¾ç½®ä¿¡æ¯çª—å†…å®¹

    })


    const zoom_in = Array.from(document.getElementsByClassName('tmap-zoom-in'));
    zoom_in.forEach(elem => {
      elem.onclick = function () { map.zoomTo(map.getZoom() + 1, 500); }
    });

    const zoom_out = Array.from(document.getElementsByClassName('tmap-zoom-out'));
    zoom_out.forEach(elem => {
      elem.onclick = function () { map.zoomTo(map.getZoom() - 1, 500); }
    });


    var backend;
    new QWebChannel(qt.webChannelTransport, function (channel) {
      backend = channel.objects.backend;
    });
    var polylineLayer = new TMap.MultiPolyline({
      id: 'polyline-layer', //å›¾å±‚å”¯ä¸€æ ‡è¯†
      map: map,//è®¾ç½®æŠ˜çº¿å›¾å±‚æ˜¾ç¤ºåˆ°å“ªä¸ªåœ°å›¾å®ä¾‹ä¸­
      //æŠ˜çº¿æ ·å¼å®šä¹‰
      styles: {
        'style_blue': new TMap.PolylineStyle({
          'color': '#3777FF', //çº¿å¡«å……è‰²
          'width': 8, //æŠ˜çº¿å®½åº¦
          'borderWidth': 2, //è¾¹çº¿å®½åº¦
          'borderColor': '#FFF', //è¾¹çº¿é¢œè‰²
          'lineCap': 'round', //çº¿ç«¯å¤´æ–¹å¼,
          'showArrow': true,
          'ArrowOptions': {
            'width': 5,
            'height': 5,
            'space': 50
          },

        }),
        'style_red': new TMap.PolylineStyle({
          'color': '#CC0000', //çº¿å¡«å……è‰²
          'width': 6, //æŠ˜çº¿å®½åº¦
          'borderWidth': 5, //è¾¹çº¿å®½åº¦
          'borderColor': '#CCC', //è¾¹çº¿é¢œè‰²
          'lineCap': 'round' //çº¿ç«¯å¤´æ–¹å¼
        })
      },
      //æŠ˜çº¿æ•°æ®å®šä¹‰
      geometries: [
      ]
    });

    document.getElementById("btn-go").addEventListener("click", function () {
      let weather_select = document.getElementById("weather");
      let weather_val = weather_select.options[weather_select.selectedIndex].value;

      let place_of_departure_index = document.getElementById("place_of_departure").selectedIndex;
      let destination_index = document.getElementById("destination").selectedIndex;

      let trip_mode_select = document.getElementById("trip_mode")
      let trip_mode_val = trip_mode_select.options[trip_mode_select.selectedIndex].value;


      let condition = {
        "weather": weather_val,
        "place_of_departure": place_of_departure_index,
        "destination": destination_index,
        "trip_mode": trip_mode_val,
        "cur_time": document.querySelector('input[type="time"]').value,
      }

      backend.foo(condition, function (arr) {
        let edges = polylineLayer.getGeometries();
        for (let i = 0; i < edges.length; i++) {
          polylineLayer.remove(edges[i]['id'])
          //alert('hello');
        }

        for (let i = 0; i < arr.length - 1; i++) {

          polyArray = arr[i].map(p => {
            return new TMap.LatLng(p[0], p[1]);
          });
          polylineLayer.add({//æ–°çš„æŠ˜çº¿æ·»åŠ åˆ°å›¾å±‚ä¸­
            'id': 'pl_2' + String(i),
            'styleId': 'style_blue',
            'paths': polyArray
          })
        }
        alert(arr[arr.length - 1])
      });

    });


    document.getElementById("btn-show_all").addEventListener("click", function () {
      backend.draw_all_edges(function (arr) {
        let edges = polylineLayer.getGeometries();
        for (let i = 0; i < edges.length; i++) {
          polylineLayer.remove(edges[i]['id'])
          //alert('hello');
        }

        for (let i = 0; i < arr.length; i++) {

          polyArray = arr[i].map(p => {
            return new TMap.LatLng(p[0], p[1]);
          });
          polylineLayer.add({//æ–°çš„æŠ˜çº¿æ·»åŠ åˆ°å›¾å±‚ä¸­
            'id': 'pl_2' + String(i),
            'styleId': 'style_blue',
            'paths': polyArray
          })
        }
      });
    })


  </script>

</body>

</html>